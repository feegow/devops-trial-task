apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: noisy-rules
  labels: { release: kps }
spec:
  groups:
    - name: app.availability
      rules:
        - alert: HighErrorRate
          expr: (sum(rate(http_requests_total{job=~"available-schedules-(python|go)",status=~"5.."}[5m])) / sum(rate(http_requests_total{job=~"available-schedules-(python|go)"}[5m])) > 0.02) and (sum(rate(http_requests_total{job=~"available-schedules-(python|go)"}[5m])) > 1)
          for: 10m
          labels:
            { severity: ticket, service: available-schedules, team: "sre" }
          annotations:
            summary: "5xx rate > 2% por 10m (available-schedules)"
            runbook_url: "runbooks/erro-5xx.md"

        - alert: HighLatencyP95
          expr: (histogram_quantile(0.95, sum by (le)(rate(http_request_duration_seconds_bucket{job=~"available-schedules-(python|go)"}[5m]))) > 0.30) and (sum(rate(http_requests_total{job=~"available-schedules-(python|go)"}[5m])) > 1)
          for: 10m
          labels: { severity: page, service: available-schedules, team: "sre" }
          annotations:
            summary: "p95 > 300ms por 10m (available-schedules)"
            runbook_url: "runbooks/latency-p95.md"
    - name: app.slo
      rules:
        - alert: ApiErrorBudgetBurnRateFast
          expr: ((sum(rate(http_requests_total{job=~"available-schedules-(python|go)",status=~"5.."}[5m])) / sum(rate(http_requests_total{job=~"available-schedules-(python|go)"}[5m]))) / 0.005) > 14.4
          for: 10m
          labels: { severity: page, service: available-schedules, team: sre }
          annotations:
            summary: "Burn-rate rÃ¡pido: risco de estourar error budget (SLO 99.5%/30d)"
            runbook_url: "runbooks/error-5xx.md"
        - alert: ApiErrorBudgetBurnRateSlow
          expr: ((sum(rate(http_requests_total{job=~"available-schedules-(python|go)",status=~"5.."}[30m])) / sum(rate(http_requests_total{job=~"available-schedules-(python|go)"}[30m]))) / 0.005) > 6
          for: 30m
          labels: { severity: ticket, service: available-schedules, team: sre }
          annotations:
            summary: "Burn-rate lento: consumo elevado do error budget (SLO 99.5%/30d)"
            runbook_url: "runbooks/error-5xx.md"
